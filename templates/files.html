{% extends "base.html" %}
{% block title %}–ü—Ä–æ–µ–∫—Ç: {{ project_name }}{% endblock %}
{% block content %}
<div class="project-page">
    <div class="project-header">
        <div class="project-title">
            <h2>üìÇ –ü—Ä–æ–µ–∫—Ç: {{ project_name }}</h2>
            <span class="status-badge status-{{ status }}">{{ status }}</span>
        </div>

        <div class="project-actions">
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                <span class="btn-icon">‚Üê</span>
                –ù–∞–∑–∞–¥ –∫ –ø—Ä–æ–µ–∫—Ç–∞–º
            </a>

            <div class="control-group">
                <form method="POST" action="{{ url_for('control_project', name=project_name) }}" class="inline-form">
                    <input type="hidden" name="action" value="start">
                    <button type="submit" class="btn btn-start">
                        <span class="btn-icon">‚ñ∂Ô∏è</span>
                        –°—Ç–∞—Ä—Ç
                    </button>
                </form>

                <form method="POST" action="{{ url_for('control_project', name=project_name) }}" class="inline-form">
                    <input type="hidden" name="action" value="stop">
                    <button type="submit" class="btn btn-stop">
                        <span class="btn-icon">‚èπÔ∏è</span>
                        –°—Ç–æ–ø
                    </button>
                </form>

                <form method="POST" action="{{ url_for('control_project', name=project_name) }}" class="inline-form">
                    <input type="hidden" name="action" value="restart">
                    <button type="submit" class="btn btn-restart">
                        <span class="btn-icon">üîÑ</span>
                        –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="content-grid">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: —Ñ–∞–π–ª—ã -->
        <div class="files-panel">
            <div class="panel-header">
                <h3>üìÑ –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞</h3>
                <div class="upload-form">
                    <form method="POST" action="{{ url_for('upload_file', name=project_name) }}"
                          enctype="multipart/form-data">
                        <input type="file" name="file" id="file-input" required hidden>
                        <label for="file-input" class="btn btn-upload">
                            <span class="btn-icon">‚¨ÜÔ∏è</span>
                            –ó–∞–≥—Ä—É–∑–∏—Ç—å
                        </label>
                        <button type="submit" class="btn btn-primary btn-upload-submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </form>
                </div>
            </div>

            {% if files|length == 0 %}
                <div class="empty-files">
                    <div class="empty-icon">üìÑ</div>
                    <p>–í –ø—Ä–æ–µ–∫—Ç–µ –Ω–µ—Ç —Ñ–∞–π–ª–æ–≤</p>
                    <small>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ main.py</small>
                </div>
            {% else %}
                <div class="files-list">
                    <table>
                        <thead>
                            <tr>
                                <th>–§–∞–π–ª</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in files %}
                            <tr class="{% if file == editing_file %}editing{% endif %}">
                                <td>
                                    {% if file == editing_file %}
                                        <strong>‚úèÔ∏è {{ file }}</strong>
                                    {% else %}
                                        {{ file }}
                                    {% endif %}
                                </td>
                                <td class="actions">
                                    <a href="{{ url_for('view_file', name=project_name, filename=file) }}"
                                       class="btn btn-small btn-edit"
                                       title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                        <span class="btn-icon">‚úèÔ∏è</span>
                                    </a>

                                    <form method="POST"
                                          action="{{ url_for('delete_file', name=project_name, filename=file) }}"
                                          class="inline-form"
                                          onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª \"{{ file }}\"?')">
                                        <button type="submit" class="btn btn-small btn-delete" title="–£–¥–∞–ª–∏—Ç—å">
                                            <span class="btn-icon">üóëÔ∏è</span>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏–ª–∏ –ª–æ–≥–∏ -->
        <div class="editor-panel">
            {% if editing_file %}
                <div class="editor-container">
                    <div class="editor-header">
                        <h3>üìù –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: {{ editing_file }}</h3>
                        <div class="editor-actions">
                            <form method="POST" action="{{ url_for('save_file', name=project_name, filename=editing_file) }}">
                                <button type="submit" class="btn btn-success">
                                    <span class="btn-icon">üíæ</span>
                                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                </button>
                            </form>
                            <a href="{{ url_for('project_files', name=project_name) }}" class="btn btn-secondary">
                                –û—Ç–º–µ–Ω–∞
                            </a>
                        </div>
                    </div>

                    <form method="POST" action="{{ url_for('save_file', name=project_name, filename=editing_file) }}">
                        <textarea name="content" class="code-editor">{{ file_content }}</textarea>
                    </form>
                </div>
            {% else %}
                <div class="logs-container">
                    <div class="logs-header">
                        <h3>üìã –õ–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h3>
                        <button class="btn btn-small btn-refresh" onclick="refreshLogs()">
                            <span class="btn-icon">üîÑ</span>
                            –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                    </div>

                    <pre id="logs" class="logs-content">{{ logs }}</pre>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤
    setupLogUpdater('{{ project_name }}');
    setupStatusUpdater('{{ project_name }}');

    function refreshLogs() {
        fetch(`/project/{{ project_name }}/logs`)
            .then(response => response.json())
            .then(data => {
                const logsElement = document.getElementById('logs');
                if (logsElement && data.logs) {
                    logsElement.textContent = data.logs;
                    logsElement.scrollTop = logsElement.scrollHeight;
                }
            });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
    document.getElementById('file-input')?.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            const fileName = e.target.files[0].name;
            if (confirm(`–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª "${fileName}"?`)) {
                e.target.parentElement.submit();
            }
        }
    });
</script>
{% endblock %}